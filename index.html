<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>
    <title>BIPMed Search</title>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <form id="search-form">
            <div class="input-group mb-4">
                <div class="input-group-prepend">
                    <label class="sr-only" for="datasetId">Dataset ID</label>
                    <select name="datasetId" id="datasetId" class="custom-select">
                        <option value="" selected>Any dataset</option>
                        <option value="bipmed-wes-phase2">bipmed-wes-phase2</option>
                    </select>
                    <label class="sr-only" for="assemblyId">Assembly ID</label>
                    <select name="assemblyId" id="assemblyId" class="custom-select">
                        <option value="" selected>Any assembly</option>
                        <option value="hg19">hg19</option>
                        <option value="GRCh38">GRCh38</option>
                    </select>
                </div>
                <label class="sr-only" for="query">Query</label>
                <input type="text" name="query" id="query" class="form-control"
                       placeholder="Gene symbol (SCN1A), genomic range (1:1000-2000), genomic position (1:1000) or SNPdb ID (rs6054257)">
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
        </form>
    </div>
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div id="error-message" class="alert alert-danger" hidden="hidden">
                Invalid query.
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <table id="result-table" class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>dbSNP</th>
                    <th>Gene Symbol</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Reference Bases</th>
                    <th>Alternate Bases</th>
                    <th>Samples</th>
                    <th>Frequency</th>

                    <th>Clinical Significance</th>

                    <th>Min Coverage</th>
                    <th>q25 Coverage</th>
                    <th>Meadian Coverage</th>
                    <th>q75 Coverage</th>
                    <th>Max Coverage</th>
                    <th>Mean Coverage</th>

                    <th>Min Genotype Quality</th>
                    <th>q25 Genotype Quality</th>
                    <th>Meadian Genotype Quality</th>
                    <th>q75 Genotype Quality</th>
                    <th>Max Genotype Quality</th>
                    <th>Mean Genotype Quality</th>

                    <th>Dataset</th>
                    <th>Assembly</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <a target="_blank" href="https://github.com/bipmed/bipmed-search/issues/new">Report issue</a>
    </div>
</div>
<script>
    $(function () {
        $('#result-table').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "https://bcbcloud.fcm.unicamp.br/bipmed",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    result.variants
                }, error: function () {
                    $("#search-message").hide();
                    $("#error-message").show();
                }
            },
            columnDefs: [{
                defaultContent: "-",
                targets: "_all"
            }],
            columns: [
                {
                    data: 'variantIds',
                    fnCreatedCell: function (nTd, sData, oData) {
                        $(nTd).html('<a target="_blank" href="https://www.ncbi.nlm.nih.gov/snp/' + oData.variantIds + '">' + oData.variantIds + "</a>");
                    }
                },
                {data: 'geneSymbol'},
                {data: 'referenceName'},
                {data: 'start'},
                {data: 'referenceBases'},
                {data: 'alternateBases'},
                {data: 'sampleCount'},
                {data: 'alleleFrequency'},

                {data: 'clnsig'},

                {data: 'minCov'},
                {data: 'q25Cov'},
                {data: 'medianCov'},
                {data: 'q75Cov'},
                {data: 'maxCov'},
                {data: 'meanCov'},

                {data: 'minGenQual'},
                {data: 'q25GenQual'},
                {data: 'medianGenQual'},
                {data: 'q75GenQual'},
                {data: 'maxGenQual'},
                {data: 'meanGenQual'},

                {data: 'datasetId'},
                {data: 'assemblyId'}
            ],
            language: {
                emptyTable: "No variant found."
            }
        });

        $("#search-form").submit(function (e) {
            e.preventDefault();
            const query = e.currentTarget.query.value;

            if (query === "") {
                $("#error-message").show();
                return;
            }

            let data = {};

            if (e.currentTarget.datasetId.value !== "") {
                data.datasetId = e.currentTarget.datasetId.value
            }

            if (e.currentTarget.assemblyId.value !== "") {
                data.assemblyId = e.currentTarget.assemblyId.value
            }

            if (/^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*-\s*(\d+)\s*$/.test(query)) {
                const regexResult = /^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*-\s*(\d+)\s*$/.exec(query);
                data.referenceName = regexResult[1];
                data.start = regexResult[2];
                data.end = regexResult[3];
            } else if (/^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*$/.test(query)) {
                const regexResult = /^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*$/.exec(query);
                data.referenceName = regexResult[1];
                data.start = regexResult[2];
            } else if (/^\s*(rs\d+)\s*$/.test(query)) {
                data.variantId = /^\s*(rs\d+)\s*$/.exec(query)[1].toLowerCase();
            } else if (/^\s*([A-Za-z0-9]+)\s*$/.test(query)) {
                data.geneSymbol = /^\s*([A-Za-z0-9]+)\s*$/.exec(query)[1].toUpperCase();
            } else {
                $("#error-message").show();
                return;
            }

            $("#error-message").hide();
        });
    })
</script>

</body>
</html>