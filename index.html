<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
    <script type="text/javascript" src="DataTables/datatables.min.js"></script>
    <title>BIPMed Search</title>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="img/bipmed-logo2.png" class="d-inline-block align-top" alt="">
            BIPMed
        </a>
    </nav>
    <form id="search-form" class="form-inline">
        <label class="sr-only" for="query">Query</label>
        <input type="text" name="query" id="query" class="form-control"
               placeholder="Gene symbol (SCN1A), genomic range (1:1000-2000), genomic position (1:1000) or SNPdb ID (rs6054257)"
               autofocus>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div id="error-message" class="alert alert-danger" hidden="hidden">
                Invalid query.
            </div>
        </div>
    </div>
    <div class="row">
        <div class="table-responsive">
            <table id="result-table" class="table table-striped table-bordered table-hove">
                <thead>
                <tr>
                    <th>dbSNP</th>
                    <th>Gene Symbol</th>
                    <th>Chromosome</th>
                    <th>Position</th>
                    <th>Reference Bases</th>
                    <th>Alternate Bases</th>
                    <th>Samples</th>
                    <th>Frequency</th>

                    <th>Clinical Significance</th>

                    <th>Min Coverage</th>
                    <th>q25 Coverage</th>
                    <th>Meadian Coverage</th>
                    <th>q75 Coverage</th>
                    <th>Max Coverage</th>
                    <th>Mean Coverage</th>

                    <th>Min Genotype Quality</th>
                    <th>q25 Genotype Quality</th>
                    <th>Meadian Genotype Quality</th>
                    <th>q75 Genotype Quality</th>
                    <th>Max Genotype Quality</th>
                    <th>Mean Genotype Quality</th>

                    <th>Dataset</th>
                    <th>Assembly</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<nav class="navbar fixed-bottom navbar-light bg-light">
    <a target="_blank" href="https://github.com/bipmed/bipmed-search/issues/new">Report issue</a>
</nav>

<script>
    $(function () {
        $("#search-form").submit(function (e) {
            e.preventDefault();
            const query = e.currentTarget.query.value;

            if (query === "") {
                $("#error-message").show();
                return;
            }

            let data = {};

            if (/^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*-\s*(\d+)\s*$/.test(query)) {
                const regexResult = /^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*-\s*(\d+)\s*$/.exec(query);
                data.referenceName = regexResult[1];
                data.start = regexResult[2];
                data.end = regexResult[3];
            } else if (/^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*$/.test(query)) {
                const regexResult = /^\s*([1-9]|1[0-9]|2[0-2]|[XY])\s*:\s*(\d+)\s*$/.exec(query);
                data.referenceName = regexResult[1];
                data.start = regexResult[2];
            } else if (/^\s*(rs\d+)\s*$/.test(query)) {
                data.variantId = /^\s*(rs\d+)\s*$/.exec(query)[1].toLowerCase();
            } else if (/^\s*([A-Za-z0-9]+)\s*$/.test(query)) {
                data.geneSymbol = /^\s*([A-Za-z0-9]+)\s*$/.exec(query)[1].toUpperCase();
            } else {
                $("#error-message").show();
                return;
            }

            $("#error-message").hide();

            $('#result-table').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: "https://bcbcloud.fcm.unicamp.br/bipmed",
                    type: "POST",
                    data: function () {
                        return JSON.stringify(data);
                    },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    dataSrc: function (result) {
                        const variants = result.variants;
                        for (let i = 0; i < variants.length; i++) {
                            const variantId = variants[i].variantIds;
                            variants[i].variantIds = '<a target="_blank" href="https://www.ncbi.nlm.nih.gov/snp/' + variantId + '">' + variantId + "</a>";
                        }
                        return variants;
                    }, error: function (error) {
                        console.log(error);
                    }
                },
                columnDefs: [{
                    defaultContent: "-",
                    targets: "_all"
                }],
                columns: [
                    {data: 'variantIds'},
                    {data: 'geneSymbol'},
                    {data: 'referenceName'},
                    {data: 'start'},
                    {data: 'referenceBases'},
                    {data: 'alternateBases'},
                    {data: 'sampleCount'},
                    {data: 'alleleFrequency'},

                    {data: 'clnsig'},

                    {data: 'minCov'},
                    {data: 'q25Cov'},
                    {data: 'medianCov'},
                    {data: 'q75Cov'},
                    {data: 'maxCov'},
                    {data: 'meanCov'},

                    {data: 'minGenQual'},
                    {data: 'q25GenQual'},
                    {data: 'medianGenQual'},
                    {data: 'q75GenQual'},
                    {data: 'maxGenQual'},
                    {data: 'meanGenQual'},

                    {data: 'datasetId'},
                    {data: 'assemblyId'}
                ],
                language: {
                    zeroRecords: "No variant found."
                },
                bDestroy: true
            });
        });
    })
</script>

</body>
</html>